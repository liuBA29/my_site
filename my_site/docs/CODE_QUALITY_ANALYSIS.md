# Анализ чистоты кода — сайт LiuBA29

Краткий разбор с точки зрения структуры, поддерживаемости и лучших практик. Ничего не меняется в коде — только рекомендации.

---

## 1. Python / Django

### 1.1 Импорты

- **`from .models import *`** в `views.py` — звёздочный импорт затрудняет понимание, откуда берутся имена, и увеличивает риск конфликтов. Лучше явно перечислять: `from .models import Project, FreeSoftware, BusinessSoftware, Order, ...`.
- В `views.py` импортируются модели и внутри функций (например `from .models import PageVisitLog, DownloadLog` в `visits_log`, `DownloadLog` в `track_download`). Имеет смысл собрать все импорты моделей в начало файла.

### 1.2 Неиспользуемый код и переменные

- **`main_page`:** переменные `project` и `show_alt_image` вычисляются, но в `render` не передаются и в шаблоне не используются. Либо убрать, либо снова использовать (например, передать в контекст).
- **`order_request`:** список `valid_service_types` дублирует варианты из `OrderForm`. Лучше брать допустимые значения из формы (например, из `form.fields['service_type'].choices`), чтобы не расходиться с формой.

### 1.3 Логирование вместо print()

- В продакшене **`print()`** не должен использоваться для отладки и ошибок: вывод может не сохраняться, в логах не будет уровней и ротации.
- Сейчас `print()` используется в:
  - `main_app/views.py` — ошибки Telegram, DEBUG по скачиваниям/ссылкам;
  - `main_app/forms.py` — предупреждения и отладка Turnstile;
  - `main_app/middleware.py` — ошибки логирования посещений;
  - `accounts/views.py`, `accounts/forms.py`, `accounts/signals.py` — аналогично.
- **Рекомендация:** заменить на `logging.getLogger(__name__)`: для ошибок — `logger.exception()` или `logger.error()`, для отладочных сообщений — `logger.debug()` и в продакшене отключать уровень DEBUG.

### 1.4 Дублирование логики

- В **`track_download`** и **`track_link`** повторяется поиск объекта по `slug`: сначала в `FreeSoftware`, потом в `BusinessSoftware`, при необходимости в `Project`. Имеет смысл вынести в общую вспомогательную функцию (например, `get_soft_or_project_by_slug(slug)`), возвращающую объект и его тип/имя, и использовать её в обоих view.

### 1.5 Длинные view

- **`order_request`** и **`track_download`** содержат много логики (валидация, Telegram, редиректы, логи). Часть можно вынести в сервисные функции или хелперы (например, «сформировать и отправить сообщение в Telegram», «получить URL и имя файла по slug и file_type»), чтобы view оставались короткими и читаемыми.

### 1.6 Импорт Http404

- В `views.py` в нескольких местах делается `from django.http import Http404` внутри функции. Лучше один раз импортировать в начале файла.

---

## 2. Шаблоны (HTML)

### 2.1 Мёртвые / устаревшие шаблоны

- В проекте есть шаблоны **`useful_soft.html`**, **`useful_soft_detail.html`**, **`test_useful.html`**, **`descriptions.html`**. В `main_app/urls.py` маршрутов на `useful_soft` нет (используются `free_soft` и `free_soft_detail`). Эти файлы выглядят как наследие старого названия раздела. Если они нигде не подключаются — их можно удалить и почистить ссылки в `django.po` (чтобы не плодить мусор в переводах).

### 2.2 Inline JavaScript в base.html

- В **base.html** в `<head>` и перед `</body>` находится много JS: определение iOS и подмена таблицы стилей, переключение темы, смена логотипа по клику/наведению, баннер cookies. Это усложняет чтение шаблона и кэширование.
- **Рекомендация:** вынести скрипты в отдельные файлы в `static/JS/` (например, `ios-styles.js`, `theme.js`, `logo.js`, `cookies-banner.js`) и подключать через `{% static %}`. Inline оставить только там, где действительно нужны данные из Django (например, `{% url ... %}` для одной переменной).

### 2.3 Дублирование в base.html

- **`{% get_available_languages as LANGUAGES %}`** вызывается дважды (для og:locale и для hreflang). Можно один раз в начале блока и использовать переменную в обоих циклах.

### 2.4 Жёстко заданные URL и текст

- URL Cloudinary, `liuba.site` в `robots_txt` и т.п. захардкожены. Для гибкости их лучше вынести в `settings` (например, `SITE_DOMAIN`, `DEFAULT_OG_IMAGE`) и использовать в шаблонах и view.
- **`alt="Обо мне"`** у логотипа не переведён. Имеет смысл использовать `{% trans "About me" %}` (или нужную фразу), чтобы при переключении языка подпись тоже менялась.

### 2.5 Форма переключения языка

- Форма с `action="#"` для переключения темы — семантически это не отправка данных на сервер. Достаточно кнопки/ссылки с `type="button"` или обработчиком, без пустого `action`.

---

## 3. CSS

### 3.1 Размер и структура

- **styles.css** — порядка 1900+ строк в одном файле. Разбить на логические части проще сопровождать: например, `base.css`, `header.css`, `footer.css`, `components.css` (карточки, кнопки, списки), `theme-dark.css`, `theme-light.css`, подключать через `@import` или несколько `<link>` в base.

### 3.2 Дублирование со styles_light.css

- Часть правил (например, футер, кнопки) повторяется в **styles.css** и **styles_light.css**. Имеет смысл выделить общие блоки в один файл, а в тематических оставлять только отличия (цвета, тени и т.д.).

### 3.3 Закрытие блока :root

- В **styles.css** блок **`:root {`** (стр. 3) не закрыт явно перед следующим правилом `body {`. После объявления переменных (в т.ч. `--font-body`) должна стоять закрывающая `}`. Сейчас браузер может «достраивать» правило сам, но для корректности и предсказуемости лучше закрыть блок явно.

### 3.4 Магические числа

- Много размеров и отступов заданы числами без переменных (например, разные `font-size`, `margin`, `padding` в px/em). В документе по типографике и сетке уже предложена шкала отступов и размеров — постепенный переход на переменные (например, `--space-*`, `--text-*`) упростит единообразие и правки.

---

## 4. Файлы в корне проекта

- В корне лежат скрипты **fix_encoding.py**, **fix_encoding_v2.py**, **fix_encoding_v3.py**, **fix_encoding_final.py**, **delete_table.py**, **delete_then_create_as_sample.py**, **insert_from_remoted.py**, **fucking_test.py**, **get-pip.py** и т.п. Часть из них разовая или отладочная.
- **Рекомендация:** рабочие утилиты перенести в каталог типа `scripts/` или `tools/`, отладочные/временные — удалить или не коммитить. Так проще не запутаться и не выполнить лишнее в продакшене.

---

## 5. Безопасность и продакшен

- **CSRF** в формах используется — хорошо.
- **Turnstile** для форм заказа и регистрации — хорошее дополнение.
- **print()** с текстами ошибок и отладочной информацией в production может попадать в stdout и косвенно «светить» внутренние детали. Замена на `logging` с уровнем и ротацией логов — нормальная практика.

---

## 6. Резюме приоритетов

| Приоритет | Что сделать |
|-----------|-------------|
| Высокий   | Закрыть блок `:root` в styles.css; убрать неиспользуемые переменные в `main_page` или снова использовать их в шаблоне. |
| Средний   | Заменить `print()` на `logging` в main_app, accounts, middleware; вынести импорты моделей в начало views.py; убрать дублирование поиска по slug в track_download/track_link. |
| Низкий    | Вынести inline JS из base.html в отдельные файлы; разбить CSS на модули; удалить мёртвые шаблоны (useful_soft*, test_useful, descriptions) и почистить django.po; перевести alt у логотипа; вынести домен и ключевые URL в settings. |

Если нужно, могу предложить конкретные правки по файлам (патчи) по любому из пунктов.
