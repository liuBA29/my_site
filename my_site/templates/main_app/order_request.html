<!-- templates/main_app/order_request.html -->
{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Order Request" %}{% endblock %}

{% block content %}
  {% if messages %}
    <div class="page-messages">
      {% for message in messages %}
        <div class="page-message {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <h1>{% trans "Submit a request" %}</h1>

  <div class="section-description">
    <p>{% trans "Fill out the form below, and I will contact you soon to discuss the details of your order." %}</p>
  </div>

  {% if product_info %}
  <div class="product-info-box">
    <h3>{% trans "Order details" %}:</h3>
    <p>
      <strong>{% trans "Product" %}:</strong> {{ product_info.product_name }}<br>
      {% if product_info.product_version %}
      <strong>{% trans "Version" %}:</strong> {{ product_info.product_version }}<br>
      {% endif %}
      {% if product_info.product_price %}
      <strong>{% trans "Price" %}:</strong> {{ product_info.product_price }}<br>
      {% endif %}
    </p>
  </div>
  {% endif %}

  <form method="post" class="order-form">
    {% csrf_token %}
    
    {% if product_info %}
    <!-- Скрытые поля для сохранения информации о продукте -->
    <input type="hidden" name="product_name" value="{{ product_info.product_name }}">
    {% if product_info.product_version %}
    <input type="hidden" name="product_version" value="{{ product_info.product_version }}">
    {% endif %}
    {% if product_info.product_price %}
    <input type="hidden" name="product_price" value="{{ product_info.product_price }}">
    {% endif %}
    {% endif %}
    
    {% if form.non_field_errors %}
      <div class="form-errors">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="form-group">
      <label for="{{ form.client_name.id_for_label }}">{{ form.client_name.label }} *</label>
      {{ form.client_name }}
      {% if form.client_name.errors %}
        <div class="field-errors">{{ form.client_name.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.client_email.id_for_label }}">{{ form.client_email.label }} *</label>
      {{ form.client_email }}
      {% if form.client_email.errors %}
        <div class="field-errors">{{ form.client_email.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.client_phone.id_for_label }}">{{ form.client_phone.label }}</label>
      {{ form.client_phone }}
      {% if form.client_phone.errors %}
        <div class="field-errors">{{ form.client_phone.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.service_type.id_for_label }}">{{ form.service_type.label }} *</label>
      {{ form.service_type }}
      {% if form.service_type.errors %}
        <div class="field-errors">{{ form.service_type.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      <label for="{{ form.description.id_for_label }}">{{ form.description.label }} *</label>
      {{ form.description }}
      {% if form.description.errors %}
        <div class="field-errors">{{ form.description.errors }}</div>
      {% endif %}
    </div>

    <div class="form-group">
      {% if CLOUDFLARE_TURNSTILE_SITE_KEY %}
        <label>{% trans "Verification" %}:</label>
        <div class="cf-turnstile" 
             data-sitekey="{{ CLOUDFLARE_TURNSTILE_SITE_KEY }}" 
             data-theme="light"
             data-callback="turnstileCallback"
             data-error-callback="turnstileErrorCallback"></div>
        <small class="form-hint">{% trans "Please complete the verification above" %}</small>
      {% endif %}
      {{ form.cf_turnstile_response }}
      {% if form.cf_turnstile_response.errors %}
        <div class="field-errors">{{ form.cf_turnstile_response.errors }}</div>
      {% endif %}
    </div>

    <button type="submit" class="submit-button">{% trans "Submit order" %}</button>
  </form>

  <style>
    .order-form {
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }

    .field-errors {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 5px;
    }

    .form-errors {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .submit-button {
      background-color: #d4edda;
      color: #155724;
      padding: 12px 30px;
      border: 1px solid #c3e6cb;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      display: inline-block;
    }

    .submit-button:hover {
      background-color: #c3e6cb;
    }

    .page-messages {
      margin: 20px 0;
      text-align: center;
    }

    .page-message {
      padding: 10px 20px;
      border-radius: 10px;
      margin: 10px auto;
      max-width: 600px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .page-message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .page-message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>

  {% if CLOUDFLARE_TURNSTILE_SITE_KEY %}
  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('.order-form');
      const turnstileInput = document.querySelector('input[name="cf_turnstile_response"]');
      const turnstileWidget = document.querySelector('.cf-turnstile');
      
      if (form && turnstileInput && turnstileWidget) {
          // Обработчик успешной проверки Turnstile
          window.turnstileCallback = function(token) {
              console.log('✅ Turnstile verification successful! Token:', token.substring(0, 20) + '...');
              turnstileInput.value = token;
          };
          
          // Обработчик ошибки Turnstile
          window.turnstileErrorCallback = function() {
              console.log('❌ Turnstile verification failed!');
              turnstileInput.value = '';
          };
          
          // Проверяем токен перед отправкой формы
          form.addEventListener('submit', function(e) {
              if (!turnstileInput.value || turnstileInput.value === '') {
                  e.preventDefault();
                  alert('{% trans "Please complete the verification." %}');
                  return false;
              }
          });
      }
  });
  </script>
  {% endif %}
{% endblock %}

