<!-- templates/chat/_lobby_partial.html -->


<h2>Добро пожаловать в чат</h2>

<div id="username-label" {% if username %}style="display:none"{% endif %}>
  <label for="username-input">Как вас зовут?</label>
</div>
<input id="username-input" type="text" value="{{ username }}" {% if username %}readonly{% endif %} placeholder="Ваше имя" />


{% if user.is_authenticated %}
  <label>Имя комнаты:</label>
  <select id="room-name-input">
    {% for name in room_names %}
    <option value="{{ name }}">{{ name }}</option>
    {% endfor %}
     </select>
{% else %}
  <input id="room-name-input" type="hidden" value="{{ room_name|default:"test" }}" />
{% endif %}

<button id="room-join">Войти</button>

<div id="chat-area" style="display: none;">
  <div id="chat-log">


  </div>
  <input id="chat-message-input" type="text" placeholder="Введите сообщение">
  <button id="chat-message-submit">Отправить</button>
</div>
<style>
  .message-left {
    text-align: left;
    background-color: #eee;
    margin: 5px;
    padding: 5px;
    border-radius: 5px;
    max-width: 70%;
  }

  .message-right {
    text-align: right;
    background-color: #d0f0c0;
    margin: 5px;
    padding: 5px;
    border-radius: 5px;
    margin-left: auto;
    max-width: 70%;
  }

  .message {
    clear: both;
  }

  .timestamp {
    font-size: 0.75em;
    color: #888;
    text-align: right;
    display: block;
  }

  #chat-log {
    border: 1px solid #ccc;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #f9f9f9;
    margin-bottom: 10px;
  }
</style>
<script>
  let chatSocket;
  let username;

  // Получение CSRF-токена из cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Форматирование времени
  function formatTime(date) {
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // Обработка входа в комнату
  function joinRoom() {
    const roomName = document.getElementById('room-name-input').value;
    username = document.getElementById('username-input').value.trim();

    if (!username) {
      alert("Пожалуйста, введите имя пользователя!");
      document.getElementById('username-input').focus();
      return;
    }

    // Закрыть старое соединение, если оно есть
    if (chatSocket) {
      chatSocket.close();
    }

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/socket-server/${roomName}/`);

    // Сохраняем имя на сервере
    fetch('/chat/set-username/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ username })
    });

    document.getElementById('chat-area').style.display = 'block';
    document.getElementById('chat-message-input').focus();

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const chatLog = document.getElementById('chat-log');
      const user = data.username || "Сервер";
      const isOwnMessage = (user === username);
      const time = formatTime(new Date());

      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', isOwnMessage ? 'message-right' : 'message-left');

      messageDiv.innerHTML = `
        <strong>${user}</strong>
        <span>${data.message}</span>
        <div class="timestamp">${time}</div>
      `;

      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function () {
      alert('Соединение с чатом потеряно.');
    };

    chatSocket.onerror = function (error) {
      console.error("Ошибка WebSocket:", error);
    };

    // Отправка сообщения
    document.getElementById('chat-message-submit').onclick = function () {
      const messageInput = document.getElementById('chat-message-input');
      const message = messageInput.value.trim();

      if (message) {
        chatSocket.send(JSON.stringify({
          message: message,
          username: username
        }));
        messageInput.value = '';
      }
    };
  }

  // Обработка нажатия Enter в поле ввода
  document.getElementById('chat-message-input').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      document.getElementById('chat-message-submit').click();
    }
  });

  // Назначаем функцию на кнопку входа
  document.getElementById('room-join').onclick = joinRoom;

  // При загрузке страницы — проверка имени пользователя
  window.addEventListener('load', function () {
    fetch('/chat/check-user/')
      .then(response => response.json())
      .then(data => {
        if (data.username) {
          document.getElementById('username-input').value = data.username;
          document.getElementById('username-input').readOnly = true;
          document.getElementById('username-label').style.display = 'none';
        } else {
          document.getElementById('username-label').style.display = 'block';
          document.getElementById('username-input').focus();
        }
      })
      .catch(error => {
        console.error("Ошибка при проверке пользователя:", error);
      });
  });
</script>
