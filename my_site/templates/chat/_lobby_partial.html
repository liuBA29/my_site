<!-- templates/chat/_lobby_partial.html -->


{% load i18n %}

<input id="username-input" type="hidden" value="{{ username }}" />


{% if user.is_authenticated %}
  {% if user.is_superuser %}
    <label for="room-name-input">{% trans "Room name:" %}</label>
    <select id="room-name-input" name="room">
      {% for name in room_names %}
      <option value="{{ name }}">{{ name }}</option>
      {% endfor %}
    </select>
  {% else %}
    <input id="room-name-input" type="hidden" value="{{ room_name|default:'myroom' }}" />
  {% endif %}
{% else %}
  <p>{% trans "To join the chat, please" %} <a href="{% url 'login' %}">{% trans "log in" %}</a> {% trans "or" %} <a href="{% url 'signup' %}">{% trans "sign up" %}</a>.</p>
{% endif %}

<!-- Блок с кнопкой Войти -->
<div id="lobby-area" style="text-align: center;">
  <button class="btn-login" id="room-join">{% trans "Join Chat" %}</button>
</div>

<!-- Блок с надписью "Вы в чате" и кнопкой Выйти, изначально скрыт -->
<div id="in-chat-area" style="display: none; text-align: center;">
  <p>{% trans "You are in chat," %} <strong><span id="chat-username">{{username}}</span></strong></p>
</div>


<div id="chat-area" style="display: none;">
  <div class="chat-log" id="chat-log">
  </div>

  <div class="chat-input-area">
  <input id="chat-message-input" type="text" placeholder="{% trans 'Enter message' %}">
    <button id="chat-message-submit">{% trans "Send" %}</button>
  </div>

</div>
<style>
    .btn-login {
      padding: 5px 10px;
      text-decoration: none;

      font-weight: bold;
      color: #FF69B4;
      background-color: transparent;
      border: 2px solid #FF69B4;
      border-radius: 5px;
      margin: 5px;
      transition: background-color 0.3s, color 0.3s;
  }

    .btn-login:hover {
      background-color: #FF69B4;
      color: white;
  }

    .btn-login:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(37, 117, 252, 0.5);
    }


  .message-left {
    text-align: left;
    background-color: #ffe4b5;
    margin: 5px;
    padding: 5px;
    border-radius: 5px;
    max-width: 70%;
  }

  .message-right {
    text-align: right;
    background-color: #d0f0c0;
    margin: 5px;
    padding: 5px;
    border-radius: 5px;
    margin-left: auto;
    max-width: 70%;
  }

.message-server {
  text-align: center;
  background-color: transparent;
  margin: 5px;
  padding: 3px;
  font-size: 0.90em;
  font-weight: normal;
  color: #999999; /* чуть темнее, но всё ещё мягкий */
  max-width: 100%;
  font-style: italic;
  opacity: 0.8; /* немного выше, чтобы лучше читался */
}




  .message {
    clear: both;
  }

  .timestamp {
    font-size: 0.75em;
    color: #888;
    text-align: right;
    display: block;
  }









  #chat-log {
    border: 1px solid #ccc;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
  }

  .chat-log {
    color: #2e2e2e;
  }

  .chat-input-area {
  display: flex;
}

#chat-message-input {
  flex: 1;
  padding: 5px;
  font-size: 1em;
}

#chat-message-submit {
  padding: 5px 10px;
  font-size: 1em;
  margin-left: 5px;
}







  .btn-login {
    position: relative;
    overflow: hidden;
    padding: 5px 10px;
    font-weight: bold;
    color: #FF69B4;
    background-color: transparent;
    border: 2px solid #FF69B4;
    border-radius: 5px;
    margin: 5px;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }

  .btn-login::before {
    content: "";
    position: absolute;
    top: 0;
    left: -150%;
    width: 200%;
    height: 100%;
    background: linear-gradient(
      120deg,
      transparent 0%,
      rgba(255, 105, 180, 0.4) 50%,
      transparent 100%
    );
    transform: skewX(-20deg);
    animation: shimmer 2.5s infinite;
  }

  @keyframes shimmer {
    0% {
      left: -150%;
    }
    50% {
      left: 100%;
    }
    100% {
      left: 100%;
    }
  }

  .btn-login:hover {
    background-color: #FF69B4;
    color: white;
  }

  .btn-login:focus {
    outline: none;
    box-shadow: 0 0 0 4px rgba(255, 105, 180, 0.3);
  }














</style>
<script>
    // ==========================
// 1. При загрузке страницы
// ==========================
  window.addEventListener('load', function () {
    fetch('/chat/check-user/')
      .then(response => response.json())
      .then(data => {
        if (data.username) {
          document.getElementById('username-input').value = data.username;
          document.getElementById('username-input').readOnly = true;
        } else {
          alert("Вы новый пользователь. Пожалуйста, введите имя.");
        }
      });
  });

  let chatSocket;
  let username;

// ==========================
// 2. Формат времени (часы:минуты)
// ==========================

    function formatTime(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

// ==========================
// 3. Присоединение к комнате
// ==========================

    document.getElementById('room-join').onclick = function() {
      const roomName = document.getElementById('room-name-input').value;
      username = document.getElementById('username-input').value;

      if (!username) {
        alert("Пожалуйста, введите имя пользователя!");
        return;
      }

      // Показать чат, скрыть лобби
  document.getElementById('chat-area').style.display = 'block';

  const isSuperUser = {{ user.is_superuser|yesno:"true,false" }};
  if (!isSuperUser) {
      // Скрываем приветствие и кнопку Войти
      document.getElementById('lobby-area').style.display = 'none';
}

      // Показываем надпись "Вы в чате" и кнопку Выйти
      document.getElementById('in-chat-area').style.display = 'block';



      document.getElementById('chat-message-input').focus();

      const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      chatSocket = new WebSocket(
      wsScheme + '://' + window.location.host +
      '/ws/socket-server/' + roomName + '/'
      );


// ==========================
  // 4. Обработка входящих сообщений
  // ==========================
      chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const chatLog = document.getElementById('chat-log');

      const user = data.username || "Сервер";


      const isOwnMessage = (user === username);
      const time = formatTime(new Date());

      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');


        if (user === "Сервер") {
            messageDiv.classList.add('message-server');
          } else if (isOwnMessage) {
            messageDiv.classList.add('message-right');
          } else {
            messageDiv.classList.add('message-left');
          }



      messageDiv.innerHTML = `
        <strong>${user}</strong>
        <span>${data.message}</span>
        <div class="timestamp">${time}</div>
      `;

      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    };

    // ==========================
  // 5. Потеря соединения
  // ==========================

    chatSocket.onclose = function (e) {
      alert('Соединение с чатом потеряно.');
      // При разрыве соединения вернуть интерфейс в начальное состояние
      document.getElementById('chat-area').style.display = 'none';
      document.getElementById('in-chat-area').style.display = 'none';
      document.getElementById('lobby-area').style.display = 'block';
    };

    // ==========================
  // 6. Отправка сообщения
  // ==========================

    document.getElementById('chat-message-submit').onclick = function () {
      const messageInput = document.getElementById('chat-message-input');
      const message = messageInput.value;
      if (message.trim() !== '') {
        chatSocket.send(JSON.stringify({
          'message': message,
          'username': username
        }));
        messageInput.value = '';
      }
    };

  // ==========================
  // 7. Выйти из комнаты
  // ==========================
    document.getElementById('room-leave').onclick = function () {
      if (chatSocket) {
        chatSocket.close();
      }
      // Очистить чат
      document.getElementById('chat-log').innerHTML = '';

      // Скрыть чат и надпись "Вы в чате"
      document.getElementById('chat-area').style.display = 'none';
      document.getElementById('in-chat-area').style.display = 'none';

      // Показать приветствие и кнопку Войти
      document.getElementById('lobby-area').style.display = 'block';
    };
  };

// ==========================
// 8. Отправка по Enter
// ==========================
  document.getElementById('chat-message-input').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      document.getElementById('chat-message-submit').click();
    }
  });

  // ==========================
// 9. Получение CSRF-токена (если понадобится)
// ==========================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
