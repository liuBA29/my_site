# Бот @myregibot — добавление клиента по Telegram

По сообщению в Telegram бот добавляет клиента в раздел **Клиенты** (contract_maker). Работает прямо из Django.

---

## Что нужно

- В `.env` заданы **TELEGRAM_BOT_TOKEN** и хотя бы один из chat_id (см. ниже).
- Бот **отвечает только тебе**: сообщения из других чатов игнорируются (защита от чужих запросов и спама).
- Бот должен быть запущен на том же компе/сервере, где крутится проект (доступ к той же БД).

### Важно: уведомления в группу vs личка с ботом

Ты пишешь боту **в личку** (private chat). В личке `chat_id` = твой **user id** (число, например 123456789).

Если **уведомления о регистрации** у тебя летят в **группу** или в другой чат, в `.env` указан **TELEGRAM_CHAT_ID** этого чата (другое число). Тогда бот не будет реагировать на твои личные сообщения, потому что сравнивает chat_id с TELEGRAM_CHAT_ID.

**Что сделать на сервере:** в `.env` добавь переменную **TELEGRAM_BOT_ALLOWED_CHAT_ID** = твой user id (узнать: напиши боту [@userinfobot](https://t.me/userinfobot) в Telegram — он пришлёт твой id). Тогда бот будет отвечать только в личке тебе, а TELEGRAM_CHAT_ID оставь для уведомлений. Пример:
```env
TELEGRAM_BOT_ALLOWED_CHAT_ID=123456789
```
После изменения перезапусти контейнер бота: `docker compose restart bot`.

### Как посмотреть логи бота (на сервере)

На сервере в каталоге с проектом выполни:
```bash
docker compose logs -f bot
```
Затем напиши боту в Telegram. В логах появится:
- **`[msg] chat_id=... text=...`** — бот получил сообщение; по `chat_id` видно, с какого чата пришло.
- **`[skip] chat_id X не в разрешённых`** — сообщение проигнорировано: этот chat_id не совпадает с TELEGRAM_BOT_ALLOWED_CHAT_ID (или TELEGRAM_CHAT_ID). Подставь указанный в логе `chat_id` в .env и перезапусти бота.
- **`[skip] не команда «добавь клиента …»`** — текст не распознан как команда добавления клиента (нужно писать вроде «Добавь клиента ООО Ромашка»).
- **`[ok] Клиент «…» добавлен`** — клиент создан, ответ ушёл в Telegram.

Выход из логов: **Ctrl+C** (останавливает только просмотр логов, бот продолжает работать).

---

## Запуск

В одном терминале — сайт (если ещё не запущен):

```bash
python manage.py runserver
```

Во **втором** терминале — бот:

```bash
python manage.py run_myregibot
```

Оставь оба окна открытыми. В консоли бота появится:  
`Бот @myregibot запущен. Ожидаю сообщения (добавь клиента …). Ctrl+C — выход.`

---

## Как пользоваться

Напиши боту в Telegram (тому, у которого токен в TELEGRAM_BOT_TOKEN, например @myregibot) **одним из вариантов**:

- **Добавь клиента ООО Ромашка**
- **Создай клиента ИП Петров**
- **Зарегистрируй компанию ЗАО Вектор**
- **Add customer Test LLC**

После названия/ФИО можно писать что угодно — в базу попадёт строка после фразы «клиента» / «компанию» / «customer».  
Бот ответит, например:  
`Клиент «ООО Ромашка» добавлен в базу (id=5).`

Проверить: на сайте **Договоры → создать договор** (или список клиентов) — новый клиент должен появиться в списке.

---

## Остановка

В терминале, где запущен `run_myregibot`, нажми **Ctrl+C**.

---

## Запуск на автомате

### Вариант 1: Docker

При запуске проекта бот уже поднимается вместе с сайтом:

```bash
docker compose up -d
```

Сервис `bot` в `docker-compose.yml` запускается автоматически и перезапускается при падении. При перезагрузке сервера после `docker compose up -d` бот снова будет работать.

---

### Вариант 2: Linux-сервер (systemd)

Чтобы бот стартовал при загрузке сервера и перезапускался при сбоях:

1. Создай unit-файл (пример в репозитории: **contract_maker/myregibot.service.example**).
2. Скопируй его в systemd и подставь свои пути и пользователя:
   ```bash
   sudo cp contract_maker/myregibot.service.example /etc/systemd/system/myregibot.service
   sudo nano /etc/systemd/system/myregibot.service
   ```
   В файле укажи:
   - **WorkingDirectory** — каталог с `manage.py`;
   - **EnvironmentFile** — путь к `.env`;
   - **ExecStart** — полный путь к `python` из venv и `manage.py run_myregibot`;
   - **User** / **Group** — пользователь, под которым крутится Django (например `www-data`).
3. Включи и запусти:
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable myregibot
   sudo systemctl start myregibot
   ```
4. Проверка: `sudo systemctl status myregibot`, логи: `sudo journalctl -u myregibot -f`.

После обновления кода: `sudo systemctl restart myregibot`.

---

### Вариант 3: Windows (локально)

- **Планировщик заданий**: создай задачу «При запуске компьютера» или «При входе в систему», действием укажи запуск `cmd` или `powershell` с командой вида  
  `C:\path\to\venv\Scripts\python.exe C:\path\to\manage.py run_myregibot`  
  (рабочая папка — каталог с `manage.py`).
- Либо положи в автозагрузку ярлык/батник, который открывает консоль и запускает эту команду (бот будет в отдельном окне).
